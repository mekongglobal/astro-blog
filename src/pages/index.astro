---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import LinkButton from "@components/LinkButton.astro";
import getSortedPosts from "@utils/getSortedPosts";
import { formatDate } from "@utils/date";
import RecentCard from "@components/card/RecentCard";

const posts = await getCollection("blog");

const sortedPosts = getSortedPosts(posts);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const latestNews = sortedPosts
  .filter(({ data }) => data.pubDatetime)
  .sort(
    (a, b) =>
      new Date(b.data.pubDatetime).getTime() -
      new Date(a.data.pubDatetime).getTime()
  )
  .slice(0, 5);

const recentPosts = sortedPosts
  .filter(({ data }) => !data.featured)
  .slice(0, 3);
---

<Layout>
  <Header />
  <main id="main-content">
    <section class="mt-10">
      <div class="grid grid-cols-1 gap-8 sm:grid-cols-3">
        <div class="lg:col-span-1">
          {
            recentPosts.length > 0 && (
              <section id="recent-posts">
                <ul>
                  {recentPosts.map(
                    ({ data, slug }, index) =>
                      index < 4 && (
                        <RecentCard
                          href={`/news/${slug}/`}
                          frontmatter={data}
                          secHeading={false}
                        />
                      )
                  )}
                </ul>
              </section>
            )
          }
        </div>
        <div class="sm:col-span-2">
          <article class="relative">
            <div class="relative h-96 overflow-hidden rounded-lg">
              <img
                src={(featuredPosts?.[0].data.ogImage ??
                  "/assets/placeholder.svg") as string}
                alt="Rescue workers in orange safety gear"
                class="h-full w-full object-cover"
              />
              <div
                class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"
              >
              </div>

              {/* Article Content Overlay */}
              <div class="lg:p-8 absolute bottom-0 left-0 right-0 p-6">
                <div
                  class="mb-4 flex items-center gap-4 space-x-3 capitalize text-white"
                >
                  {featuredPosts[0]?.data?.tags[0].split("-").join(" ")}

                  <span class="text-sm text-white/80"
                    >{
                      featuredPosts[0].data.pubDatetime
                        ? formatDate(
                            new Date(
                              featuredPosts[0]?.data?.pubDatetime
                            ).toDateString()
                          )
                        : "N/A"
                    }</span
                  >
                </div>
                <h1
                  class="lg:text-4xl text-2xl font-bold leading-tight text-white"
                >
                  {featuredPosts[0].data.description || ""}
                </h1>
              </div>
            </div>
          </article>
        </div>
      </div>

      <div class="mb-10 mt-10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-8 w-1 bg-black"></div>
          <h2 class="text-3xl font-bold">LATEST NEWS</h2>
        </div>
        <LinkButton href="/news/">
          All News
          <svg xmlns="http://www.w3.org/2000/svg"
            ><path
              d="m11.293 17.293 1.414 1.414L19.414 12l-6.707-6.707-1.414 1.414L15.586 11H6v2h9.586z"
            ></path>
          </svg>
        </LinkButton>
      </div>

      <div class="mb-8 grid grid-cols-1 gap-8 sm:grid-cols-2">
        <div class="lg:col-span-1 grid grid-cols-2 gap-4">
          {
            latestNews.slice(0, 4).map(article => (
              <a href={`/news/${article.slug}/`}>
                <article class="group cursor-pointer">
                  <div class="relative mb-4 overflow-hidden rounded-lg">
                    <img
                      src={
                        (article.data.ogImage ||
                          "/assets/placeholder.svg") as string
                      }
                      alt={article.data.title}
                      width={300}
                      height={200}
                      class="h-48 w-full object-cover transition-transform duration-300 group-hover:scale-105"
                    />
                  </div>
                  <h3 class="mb-3 text-lg font-semibold leading-tight  transition-colors group-hover:text-gray-600">
                    {article.data.title}
                  </h3>
                  <div class="flex items-center gap-4 text-sm ">
                    <span>
                      {article.data.pubDatetime
                        ? formatDate(
                            new Date(article.data.pubDatetime).toDateString()
                          )
                        : "N/A"}
                    </span>
                  </div>
                </article>
              </a>
            ))
          }
        </div>
        <div class="lg:col-span-1">
          <article class="group cursor-pointer">
            <div class="relative mb-4 overflow-hidden rounded-lg">
              <img
                src={(latestNews.slice(4, 5)[0].data.ogImage ||
                  "/assets/placeholder.svg") as string}
                alt={latestNews.slice(4, 5)[0].data.title}
                width={600}
                height={400}
                class="h-auto w-full object-cover transition-transform duration-300 group-hover:scale-105"
              />
            </div>
            <h3
              class="mb-3 text-2xl font-bold leading-tight transition-colors group-hover:text-gray-600"
            >
              {latestNews.slice(4, 5)[0].data.title}
            </h3>
            <p class="mb-4 leading-relaxed">
              {latestNews.slice(4, 5)[0].data.description}
            </p>
            <div class="flex items-center gap-4 text-sm">
              <span
                >{
                  latestNews
                    ? formatDate(
                        new Date(
                          latestNews.slice(4, 5)[0].data.pubDatetime
                        ).toDateString()
                      )
                    : ""
                }</span
              >
            </div>
          </article>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<style>
  /* ===== Hero Section ===== */
  #hero {
    @apply pb-6 pt-8;
  }
  #hero h1 {
    @apply my-4 inline-block text-3xl font-bold sm:my-8 sm:text-5xl;
  }
  #hero .rss-link {
    @apply mb-6;
  }
  #hero .rss-icon {
    @apply mb-2 h-6 w-6 scale-110 fill-skin-accent sm:mb-3 sm:scale-125;
  }
  #hero p {
    @apply my-2;
  }
  .social-wrapper {
    @apply mt-4 flex flex-col sm:flex-row sm:items-center;
  }
  .social-links {
    @apply mb-1 mr-2 whitespace-nowrap sm:mb-0;
  }

  /* ===== Featured & Recent Posts Sections ===== */
  #featured,
  #recent-posts {
    @apply pb-6;
  }
  #featured h2,
  #recent-posts h2 {
    @apply text-2xl font-semibold tracking-wide;
  }
  .all-posts-btn-wrapper {
    @apply my-8 text-center;
  }
</style>
